<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>InkVision Designer</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #333; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        .hidden { display: none !important; }

        /* --- Drawing Editor --- */
        #editor { background-color: #f0f0f0; }
        #drawingCanvas { display: block; touch-action: none; cursor: crosshair; }
        #editor-controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
        .btn { background: #007aff; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-secondary { background: #e5e5ea; color: #000; }

        /* --- AR View --- */
        #ar-view { background: #000; }
        #camera, #arCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #arCanvas { z-index: 10; }
        #ar-controls { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); }
        #status { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: lime; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; }
    </style>
</head>
<body>

    <!-- STATE 1: The Drawing Editor -->
    <div id="editor" class="screen">
        <canvas id="drawingCanvas"></canvas>
        <div id="editor-controls">
            <button id="clearBtn" class="btn btn-secondary">Clear</button>
            <button id="tryOnBtn" class="btn">Try On üëÅÔ∏è</button>
        </div>
    </div>

    <!-- STATE 2: The AR Preview -->
    <div id="ar-view" class="screen hidden">
        <video id="camera" autoplay playsinline muted></video>
        <canvas id="arCanvas"></canvas>
        <div id="ar-controls">
            <button id="backBtn" class="btn btn-secondary">‚¨ÖÔ∏è Back to Editor</button>
        </div>
        <div id="status">Loading AI...</div>
    </div>

    <!-- Load AI Engine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <!-- App Logic -->
    <script>
        // --- DOM ELEMENTS ---
        const editorScreen = document.getElementById('editor');
        const arScreen = document.getElementById('ar-view');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const dCtx = drawingCanvas.getContext('2d');
        const video = document.getElementById('camera');
        const arCanvas = document.getElementById('arCanvas');
        const arCtx = arCanvas.getContext('2d');
        const statusEl = document.getElementById('status');
        
        // --- APP STATE & GLOBALS ---
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let aiModel = null;
        let animationFrameId = null;
        const tattooImage = new Image();

        // --- DRAWING LOGIC ---
        function setupDrawingCanvas() {
            drawingCanvas.width = window.innerWidth;
            drawingCanvas.height = window.innerHeight;
            dCtx.fillStyle = 'white';
            dCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            dCtx.strokeStyle = 'black';
            dCtx.lineWidth = 5;
            dCtx.lineCap = 'round';
            dCtx.lineJoin = 'round';
        }

        function startDraw(e) {
            isDrawing = true;
            [lastX, lastY] = getCoords(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [x, y] = getCoords(e);
            dCtx.beginPath();
            dCtx.moveTo(lastX, lastY);
            dCtx.lineTo(x, y);
            dCtx.stroke();
            [lastX, lastY] = [x, y];
        }

        function stopDraw() { isDrawing = false; }

        function getCoords(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            if (e.touches) {
                return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
            }
            return [e.clientX - rect.left, e.clientY - rect.top];
        }

        // --- AI & CAMERA LOGIC ---
        async function startAR() {
            statusEl.innerText = "Starting Camera...";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                await video.play();
                statusEl.innerText = "Loading AI Brain...";
                if (!aiModel) aiModel = await cocoSsd.load();
                statusEl.innerText = "AI Active. Point at person.";
                detectLoop();
            } catch (err) {
                statusEl.innerText = "Camera or AI failed.";
                console.error(err);
            }
        }
        
        function stopAR() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function detectLoop() {
            aiModel.detect(video).then(predictions => {
                drawAR(predictions);
                animationFrameId = requestAnimationFrame(detectLoop);
            });
        }
        
        function drawAR(predictions) {
            arCanvas.width = window.innerWidth;
            arCanvas.height = window.innerHeight;
            arCtx.clearRect(0, 0, arCanvas.width, arCanvas.height);

            const person = predictions.find(p => p.class === 'person');
            if (person) {
                const [x, y, w, h] = person.bbox;
                const scaleX = arCanvas.width / video.videoWidth;
                const scaleY = arCanvas.height / video.videoHeight;
                const scale = Math.max(scaleX, scaleY);
                const offsetX = (arCanvas.width - video.videoWidth * scale) / 2;
                const offsetY = (arCanvas.height - video.videoHeight * scale) / 2;

                const screenX = x * scale + offsetX;
                const screenY = y * scale + offsetY;
                const screenW = w * scale;
                const screenH = h * scale;

                arCtx.globalCompositeOperation = 'multiply';
                arCtx.drawImage(tattooImage, screenX, screenY, screenW, screenH);
                arCtx.globalCompositeOperation = 'source-over';
                
                // Optional: Draw green debug box
                arCtx.strokeStyle = 'lime';
                arCtx.lineWidth = 4;
                arCtx.strokeRect(screenX, screenY, screenW, screenH);
            }
        }

        // --- EVENT LISTENERS & MAIN ---
        function switchToAR() {
            // Capture drawing
            tattooImage.src = drawingCanvas.toDataURL();
            // Switch screens
            editorScreen.classList.add('hidden');
            arScreen.classList.remove('hidden');
            startAR();
        }

        function switchToEditor() {
            arScreen.classList.add('hidden');
            editorScreen.classList.remove('hidden');
            stopAR();
        }

        document.getElementById('tryOnBtn').addEventListener('click', switchToAR);
        document.getElementById('backBtn').addEventListener('click', switchToEditor);
        document.getElementById('clearBtn').addEventListener('click', setupDrawingCanvas);

        // For drawing on canvas
        drawingCanvas.addEventListener('mousedown', startDraw);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDraw);
        drawingCanvas.addEventListener('mouseout', stopDraw);
        drawingCanvas.addEventListener('touchstart', startDraw, { passive: false });
        drawingCanvas.addEventListener('touchmove', draw, { passive: false });
        drawingCanvas.addEventListener('touchend', stopDraw);
        
        // Initial setup
        setupDrawingCanvas();
    </script>
</body>
</html>
